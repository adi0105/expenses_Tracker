<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .settings-container {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .settings-section:last-child {
            border-bottom: none;
        }
        
        .settings-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .currency-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
        }
        
        .currency-option {
            padding: 8px;
        }
        
        .currency-info {
            margin-top: 10px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            display: none;
        }
        
        .currency-info.show {
            display: block;
        }
        
        .currency-info h3 {
            margin-top: 0;
            font-size: 16px;
        }
        
        .currency-symbol {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        
        .currency-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .currency-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .currency-item:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .currency-item.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        .btn-secondary {
            background-color: #666;
        }
        
        .btn-secondary:hover {
            background-color: #555;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .user-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .user-info p {
            margin: 8px 0;
            color: #666;
        }
        
        .user-info strong {
            color: #333;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        header nav {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        header a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
        }
        
        header a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb {
            max-width: 600px;
            margin: 0 auto 20px;
            padding: 0 20px;
            font-size: 14px;
            color: #666;
        }
        
        .breadcrumb a {
            color: #4CAF50;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <h1 style="margin: 0;">Expense Tracker</h1>
            <div>
                <a href="{{ url_for('dashboard') }}">Dashboard</a>
                <a href="{{ url_for('auth.logout') }}">Logout</a>
            </div>
        </nav>
    </header>
    
    <div class="breadcrumb">
        <a href="{{ url_for('dashboard') }}">Dashboard</a> / Settings
    </div>
    
    <div class="settings-container">
        <h1>Settings</h1>
        
        <div id="message" class="message" role="status" aria-live="polite"></div>
        
        <!-- User Profile Section -->
        <div class="settings-section">
            <h2>ðŸ‘¤ Profile</h2>
            <div class="user-info" id="userInfo">
                <p><strong>Loading...</strong></p>
            </div>
        </div>
        
        <!-- Currency Settings Section -->
        <div class="settings-section">
            <h2>ðŸ’± Currency Settings</h2>
            
            <div class="form-group">
                <label for="currencySelect">Select Your Preferred Currency:</label>
                <select id="currencySelect" class="currency-select" aria-required="true">
                    <option value="">-- Loading --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="customSymbol">Custom Currency Symbol (optional):</label>
                <input id="customSymbol" type="text" placeholder="e.g. $, â‚¹, â‚¬" maxlength="10" style="padding:10px; width:100%; border:1px solid #ddd; border-radius:4px;">
                <small style="color:#666">If set, this symbol will be used instead of the default for your selected currency.</small>
            </div>
            
            <div id="currencyInfo" class="currency-info">
                <h3>Currency Information</h3>
                <div>
                    <strong>Code:</strong> <span id="currencyCode">-</span>
                </div>
                <div>
                    <strong>Name:</strong> <span id="currencyName">-</span>
                </div>
                <div class="currency-symbol" id="currencySymbol">-</div>
                <p style="color: #666; font-size: 13px; margin-top: 10px;">
                    All amounts in your dashboard will be displayed using this currency symbol.
                </p>
            </div>
            
            <div class="button-group">
                <button class="btn" onclick="saveCurrency()">Save Currency</button>
                <button class="btn btn-secondary" onclick="resetCurrency()">Reset</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let currentCurrency = 'INR';
        let selectedCurrency = 'INR';
        let availableCurrencies = [];
        
        // Load user profile and currency settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            loadCurrencySettings();
        });
        
        // Load user profile
        function loadUserProfile() {
            fetch('/api/settings/profile', { credentials: 'same-origin' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const user = data.user;
                        document.getElementById('userInfo').innerHTML = `
                            <p><strong>Username:</strong> ${user.username}</p>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Account Created:</strong> ${new Date(user.created_at).toLocaleDateString()}</p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading profile:', error);
                    showMessage('Error loading profile', 'error');
                });
        }
        
        // Load currency settings
        function loadCurrencySettings() {
            fetch('/api/settings/currency', { credentials: 'same-origin' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentCurrency = data.current_currency;
                        selectedCurrency = data.current_currency;
                        availableCurrencies = data.available_currencies;
                        
                        // Populate select options
                        const select = document.getElementById('currencySelect');
                        select.innerHTML = '';
                        
                        availableCurrencies.forEach(currency => {
                            const option = document.createElement('option');
                            option.value = currency.code;
                            option.textContent = `${currency.flag} ${currency.code} - ${currency.name}`;
                            option.selected = currency.code === currentCurrency;
                            select.appendChild(option);
                        });
                        
                        // Display current currency info
                        // If user has a custom symbol, populate the input and show it
                        document.getElementById('customSymbol').value = data.custom_symbol || '';
                        updateCurrencyInfo(currentCurrency);
                        if (data.custom_symbol) {
                            document.getElementById('currencySymbol').textContent = data.custom_symbol;
                        }
                        
                        // Add event listener for select change
                        select.addEventListener('change', function(e) {
                            selectedCurrency = e.target.value;
                            updateCurrencyInfo(selectedCurrency);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading currency settings:', error);
                    showMessage('Error loading currency settings', 'error');
                });
        }
        
        // Update currency info display
        function updateCurrencyInfo(currencyCode) {
            const currency = availableCurrencies.find(c => c.code === currencyCode);
            if (currency) {
                document.getElementById('currencyCode').textContent = currency.code;
                document.getElementById('currencyName').textContent = currency.name;
                document.getElementById('currencySymbol').textContent = currency.symbol;
                document.getElementById('currencyInfo').classList.add('show');
            }
        }
        
        // Save currency
        function saveCurrency() {
            if (selectedCurrency === currentCurrency) {
                showMessage('No currency change made', 'error');
                return;
            }
            
            fetch('/api/settings/currency', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                    currency: selectedCurrency,
                    symbol: document.getElementById('customSymbol').value || null
                })
            })
                .then(response => response.json())
                .then(data => {
                        if (data.success) {
                        currentCurrency = selectedCurrency;
                        showMessage(`âœ“ Currency changed to ${data.new_currency}! All amounts will now display in the new currency.`, 'success');
                        // If client CurrencyManager exists, tell it to reload preference
                        if (window.CurrencyManager && typeof window.CurrencyManager.loadUserCurrency === 'function') {
                            window.CurrencyManager.loadUserCurrency();
                        }
                        // Reload dashboard after 1.5 seconds (optional fallback)
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1500);
                    } else {
                        showMessage('Error: ' + (data.message || 'Failed to save currency'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error saving currency:', error);
                    showMessage('Error saving currency', 'error');
                });
        }
        
        // Reset currency
        function resetCurrency() {
            selectedCurrency = currentCurrency;
            document.getElementById('currencySelect').value = currentCurrency;
            updateCurrencyInfo(currentCurrency);
            showMessage('Reset to current currency', 'error');
        }
        
        // Show message
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `message ${type}`;
            
            // Auto-hide after 5 seconds if success
            if (type === 'success') {
                setTimeout(() => {
                    messageEl.className = 'message';
                }, 5000);
            }
        }
    </script>
</body>
</html>
